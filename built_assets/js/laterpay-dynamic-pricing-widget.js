var margin={top:37,right:40,bottom:15,left:50};margin.xAxis=margin.left+margin.right,margin.yAxis=margin.top+margin.bottom;var DynamicPricingWidget=function(i){var t,n=this;this.container=i,this.interpolation="linear",this.minPrice=0,this.maxPrice=5,this.defaultPrice=.49,this.payLaterPrice="USD"===lpVars.currency?1.99:1,this.currentPrice=0,this.pubDays=0,this.currency=lpVars.currency,this.i18nDefaultPrice=lpVars.i18nDefaultPrice,this.i18nPayLater=lpVars.i18nPayLater,this.i18nDays=lpVars.i18nDays,this.i18nToday=lpVars.i18nToday,this.dragging=!1,this.currentStartPricePosition=null,this.currentEndPricePosition=null,this.showPayLaterText=!1;var a=parseFloat(jQuery("#lp_js_postPriceInput").val());("USD"===lpVars.currency&&2<=a||"EUR"===lpVars.currency&&1.5<=a)&&(this.showPayLaterText=!0),(t=d3.select(i).append("svg").attr("class","lp_dynamic-pricing__svg").append("g").attr("class","lp_dynamic-pricing__svg-group")).append("rect").attr("class","lp_dynamic-pricing__graph-background"),t.append("g").attr("class","lp_dynamic-pricing__axis lp_dynamic-pricing__axis--x"),t.append("g").attr("class","lp_dynamic-pricing__axis lp_dynamic-pricing__axis--y"),t.append("defs").append("marker").attr({id:"lp_dynamic-pricing__axis-arrowhead--x",class:"lp_dynamic-pricing__axis-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,0 V4 L4,2 Z"),t.append("defs").append("marker").attr({id:"lp_dynamic-pricing__axis-arrowhead--y",class:"lp_dynamic-pricing__axis-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,4 H4 L2,0 Z"),t.append("line").attr("class","lp_dynamic-pricing__default-price-marker"),t.append("rect").attr({class:"lp_dynamic-pricing__default-price-label-background",width:66,height:16}),t.append("text").attr("transform","translate(0, 2.5)").attr("class","lp_dynamic-pricing__default-price-label").attr("text-anchor","middle").text(this.i18nDefaultPrice);var e="USD"===lpVars.currency?105:125;!0===this.showPayLaterText&&(t.append("line").attr("class","lp_dynamic-pricing__pay-later-price-marker"),t.append("rect").attr({class:"lp_dynamic-pricing__pay-later-price-label-background",width:60,height:16}),t.append("text").attr("transform","translate(85,"+e+")").attr("class","lp_dynamic-pricing__default-price-label").attr("text-anchor","middle").text(this.i18nPayLater)),t.append("path").attr("class","lp_dynamic-pricing__price-curve"),t.append("rect").attr({class:"lp_dynamic-pricing__start-price-handle",width:32,rx:3,height:29,ry:3}),t.append("path").attr("class","lp_dynamic-pricing__start-price-handle-triangle"),t.insert("foreignObject").attr({class:"lp_dynamic-pricing__start-price-input-wrapper",width:"56px",height:"30px"}).html('<input type="text" class="lp_dynamic-pricing__start-price-input" maxlength="6">'),t.append("text").attr("class","lp_dynamic-pricing__start-price-value lp_dynamic-pricing__handle-text").attr("text-anchor","end"),t.append("text").attr("class","lp_dynamic-pricing__start-price-currency lp_dynamic-pricing__handle-text lp_dynamic-pricing__handle-unit").attr("text-anchor","end").text(this.currency),t.append("rect").attr({class:"lp_dynamic-pricing__end-price-handle",width:32,rx:3,height:29,ry:3}),t.append("path").attr("class","lp_dynamic-pricing__end-price-handle-triangle"),t.insert("foreignObject").attr({class:"lp_dynamic-pricing__end-price-input-wrapper",width:"56px",height:"30px"}).html('<input type="text" class="lp_dynamic-pricing__end-price-input" maxlength="6">'),t.append("text").attr("class","lp_dynamic-pricing__end-price-value lp_dynamic-pricing__handle-text").attr("text-anchor","end"),t.append("text").attr("class","lp_dynamic-pricing__end-price-currency lp_dynamic-pricing__handle-text lp_dynamic-pricing__handle-unit").attr("text-anchor","end").text(this.currency),this.svg=t,jQuery(window).bind("resize",function(){n.plot()}),jQuery("body").on("mousedown",".lp_dynamic-pricing__start-price-handle, .lp_dynamic-pricing__start-price-value, .lp_dynamic-pricing__start-price-currency",function(i){n.currentStartPricePosition=i.pageY,jQuery("body").on("mousemove",function i(t){n.currentStartPricePosition=t.pageY,jQuery("body").off("mousemove",i)})}).on("mouseup",".lp_dynamic-pricing__start-price-handle, .lp_dynamic-pricing__start-price-value, .lp_dynamic-pricing__start-price-currency",function(i){i.pageY===n.currentStartPricePosition&&dynamicPricingWidget.toggleStartInput("show")}).on("focusout",".lp_dynamic-pricing__start-price-input",function(){dynamicPricingWidget.toggleStartInput("save")}).on("keydown",".lp_dynamic-pricing__start-price-input",function(i){13===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleStartInput("save"))}).on("keydown",".lp_dynamic-pricing__start-price-input",function(i){27===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleStartInput("cancel"))}),jQuery("body").on("mousedown",".lp_dynamic-pricing__end-price-handle, .lp_dynamic-pricing__end-price-value, .lp_dynamic-pricing__end-price-currency",function(i){n.currentEndPricePosition=i.pageY,jQuery("body").on("mousemove",function i(t){n.currentEndPricePosition=t.pageY,jQuery("body").off("mousemove",i)})}).on("mouseup",".lp_dynamic-pricing__end-price-handle, .lp_dynamic-pricing__end-price-value, .lp_dynamic-pricing__end-price-currency",function(i){i.pageY===n.currentEndPricePosition&&dynamicPricingWidget.toggleEndInput("show")}).on("focusout",".lp_dynamic-pricing__end-price-input",function(){dynamicPricingWidget.toggleEndInput("save")}).on("keydown",".lp_dynamic-pricing__end-price-input",function(i){13===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleEndInput("save"))}).on("keydown",".lp_dynamic-pricing__end-price-input",function(i){27===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleEndInput("cancel"))})};DynamicPricingWidget.prototype.interpolate=function(i){return this.interpolation=i,this},DynamicPricingWidget.prototype.setPrice=function(i,t,n){return this.minPrice=i,this.maxPrice=t,n&&(this.defaultPrice=n),this},DynamicPricingWidget.prototype.set_data=function(i){return this.data=i,this},DynamicPricingWidget.prototype.get_data=function(){return this.data},DynamicPricingWidget.prototype.set_today=function(i,t){return this.pubDays=i,this.currentPrice=t,this},DynamicPricingWidget.prototype._setDimensions=function(){this.dimensions={width:jQuery(this.container).width()-margin.xAxis,height:jQuery(this.container).height()-margin.yAxis}},DynamicPricingWidget.prototype._setScale=function(){this.scale={x:d3.scale.linear().range([0,this.dimensions.width+10]),y:d3.scale.linear().range([this.dimensions.height,0])}},DynamicPricingWidget.prototype._plotAxes=function(){this.xExtent=d3.extent(this.data,function(i){return i.x}),this.yExtent=[0,this.maxPrice];var i=d3.svg.axis().scale(this.scale.x).tickSize(-this.dimensions.height,0,0).ticks(7).orient("bottom"),t=d3.svg.axis().scale(this.scale.y).tickSize(-this.dimensions.height,0,0).ticks(7).orient("left");this.scale.x.domain(this.xExtent),this.scale.y.domain(this.yExtent),this.svg.select(".lp_dynamic-pricing__axis--x").attr({transform:"translate(0,"+this.dimensions.height+")","marker-end":"url(#lp_dynamic-pricing__axis-arrowhead--x)"}).transition().duration(this.dragging?0:250).call(i),this.svg.select(".lp_dynamic-pricing__axis--y").attr("marker-start","url(#lp_dynamic-pricing__axis-arrowhead--y)").transition().duration(this.dragging?0:250).call(t),d3.selectAll(".tick").select("line").attr("class","lp_dynamic-pricing__grid-line"),d3.selectAll(".tick").select("text").attr("class","lp_dynamic-pricing__grid-line-label"),this.svg.select(".lp_dynamic-pricing__default-price-marker").transition().duration(this.dragging?0:250).attr({x1:0,y1:this.scale.y(this.defaultPrice),x2:this.dimensions.width+10,y2:this.scale.y(this.defaultPrice)}),this.svg.select(".lp_dynamic-pricing__default-price-label-background").transition().duration(this.dragging?0:250).attr({x:(this.dimensions.width-66)/2,y:this.scale.y(this.defaultPrice)-9}),this.svg.select(".lp_dynamic-pricing__default-price-label").transition().duration(this.dragging?0:250).attr({x:this.dimensions.width/2,y:this.scale.y(this.defaultPrice)}),!0===this.showPayLaterText&&(this.svg.select(".lp_dynamic-pricing__pay-later-price-marker").transition().duration(this.dragging?0:250).attr({x1:0,y1:this.scale.y(this.payLaterPrice),x2:this.dimensions.width+10,y2:this.scale.y(this.payLaterPrice)}),this.svg.select(".lp_dynamic-pricing__pay-later-price-label-background").transition().duration(this.dragging?0:250).attr({x:(this.dimensions.width-60)/2,y:this.scale.y(this.payLaterPrice)-9}),this.svg.select(".lp_dynamic-pricing__pay-later-price-label").transition().duration(this.dragging?0:250).attr({x:this.dimensions.width/2,y:this.scale.y(this.payLaterPrice)}))},DynamicPricingWidget.prototype._plotPriceCurve=function(){var t=this,i=d3.svg.line().interpolate(this.interpolation).x(function(i){return t.scale.x(i.x)}).y(function(i){return t.scale.y(i.y)});this.svg.select(".lp_dynamic-pricing__price-curve").datum(this.data).transition().duration(this.dragging?0:250).attr("d",i)},DynamicPricingWidget.prototype._setDragBehavior=function(){var d,p=60;this.dragBehavior={x:d3.behavior.drag().on("dragstart",function(){this.dragging=!0}.bind(this)).on("drag",function(i,t){var n,a,e,r=this.scale.x.invert(d3.event.x),c=t===this.data.length-2,s=t===this.data.length-3;c?(a=(r-i.x)/(1e3/p),e=function(){n=+i.x+a,n=Math.max(n,this.data[t].x+.51),n=Math.max(n,29.51),n=Math.min(n,366.49),i.x=n,this.scale.x.domain(d3.extent(this.data,function(i){return i.x})),this.plot()},clearInterval(d),d=setInterval(e,1e3/p),e()):(s?(n=r,n=Math.max(n,this.data[t].x+.51),n=Math.min(n,366.49),this.data[t+2].x=25<=n?n+5:30,i.x=n,this.scale.x.domain(d3.extent(this.data,function(i){return i.x}))):(n=r,n=Math.max(n,this.data[t].x+.51),n=Math.min(n,this.data[t+2].x-.51),i.x=n,this.scale.x.domain(d3.extent(this.data,function(i){return i.x}))),this.plot())}.bind(this)).on("dragend",function(){clearInterval(d),this.dragging=!1;for(var i=0,t=this.data.length;i<t;i++)this.data[i].x=Math.round(this.data[i].x);this.plot()}.bind(this)),y:d3.behavior.drag().on("dragstart",function(){this.dragging=!0}.bind(this)).on("drag",function(i,t){var n=this.scale.y.invert(d3.event.y);n<this.yExtent[0]&&(n=this.yExtent[0]),n>this.yExtent[1]&&(n=this.yExtent[1]),i.y=n,0===t&&this.data[0].x===i.x?this.data[1].y=i.y:1===t?this.data[0].y=i.y:0===t&&this.data[this.data.length-1].x===i.x?this.data[this.data.length-2].y=i.y:t===this.data.length-2&&(this.data[this.data.length-1].y=i.y),this.plot()}.bind(this)).on("dragend",function(){this.dragging=!1}.bind(this))}},DynamicPricingWidget.prototype._plotStartPriceHandle=function(){var t=this;this.svg.select(".lp_dynamic-pricing__start-price-handle").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-38},y:function(i){return t.scale.y(i.y)-14.5}}),this.svg.select(".lp_dynamic-pricing__start-price-handle-triangle").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr("d",function(i){return"M -6 "+(t.scale.y(i.y)-5)+" l 5 5 l -5 5 z"}),this.svg.select(".lp_dynamic-pricing__start-price-value").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-7},y:function(i){return t.scale.y(i.y)-.5}}).text(function(i){return-1!==lpVars.locale.indexOf("de_DE")?i.y.toFixed(2).replace(".",","):i.y.toFixed(2)}),this.svg.select(".lp_dynamic-pricing__start-price-currency").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-8},y:function(i){return t.scale.y(i.y)+9.5}}),this.svg.select(".lp_dynamic-pricing__start-price-input-wrapper").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-38},y:function(i){return t.scale.y(i.y)-14}})},DynamicPricingWidget.prototype._plotEndPriceHandle=function(){var t=this;this.svg.select(".lp_dynamic-pricing__end-price-handle").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return jQuery(".lp_dynamic-pricing__end-price-input-wrapper")&&jQuery(".lp_dynamic-pricing__end-price-input").is(":visible")?t.dimensions.width:t.dimensions.width+16},y:function(i){return t.scale.y(i.y)-15}}),this.svg.select(".lp_dynamic-pricing__end-price-value").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return t.dimensions.width+47},y:function(i){return t.scale.y(i.y)-1}}).text(function(i){return-1!==lpVars.locale.indexOf("de_DE")?i.y.toFixed(2).replace(".",","):i.y.toFixed(2)}),this.svg.select(".lp_dynamic-pricing__end-price-currency").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return t.dimensions.width+47},y:function(i){return t.scale.y(i.y)+9}}),this.svg.select(".lp_dynamic-pricing__end-price-handle-triangle").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr("d",function(i){return"M "+(t.dimensions.width+16)+" "+(t.scale.y(i.y)+5)+" l 0 -10 l -5 5 z"}),this.svg.select(".lp_dynamic-pricing__end-price-input-wrapper").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return t.dimensions.width-8},y:function(i){return t.scale.y(i.y)-15}})},DynamicPricingWidget.prototype._plotDaysHandle=function(){var a=this,i=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-handle").data(this.data.slice(1,this.data.length));i.enter().append("rect").attr("class",function(i,t){var n="lp_dynamic-pricing__price-change-days-handle";return t===a.data.length-2&&(n+=" lp_is-hidden"),n}).call(this.dragBehavior.x),i.exit().remove(),i.transition().duration(this.dragging?0:250).attr({x:function(i){return a.scale.x(i.x)-15},y:function(){return-35},width:30,rx:3,height:30,ry:3});var t=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-handle-triangle").data(this.data.slice(1,this.data.length));t.enter().append("path").attr("class",function(i,t){var n="lp_dynamic-pricing__price-change-days-handle-triangle";return t===a.data.length-2&&(n+=" lp_is-hidden"),n}).call(this.dragBehavior.x),t.exit().remove(),t.transition().duration(this.dragging?0:250).attr("d",function(i){return"M "+(a.scale.x(i.x)-5)+" "+-5+" l 10 0 l -5 5 z"});var n=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-value").data(this.data.slice(1,this.data.length));n.enter().append("text").attr("class",function(i,t){var n="lp_dynamic-pricing__price-change-days-value lp_dynamic-pricing__handle-text";return t===a.data.length-2&&(n+=" lp_is-hidden"),n}).call(this.dragBehavior.x),n.exit().remove(),n.transition().duration(this.dragging?0:250).text(function(i){return Math.round(i.x)}).attr({x:function(i){return a.scale.x(i.x)},y:function(){return-21},height:30,"text-anchor":"middle"});var e=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-unit").data(this.data.slice(1,this.data.length));e.enter().append("text").attr("class",function(i,t){var n="lp_dynamic-pricing__price-change-days-unit lp_dynamic-pricing__handle-text lp_dynamic-pricing__handle-unit";return t===a.data.length-2&&(n+=" lp_is-hidden"),n}).call(this.dragBehavior.x),e.exit().remove(),e.transition().duration(this.dragging?0:250).text(this.i18nDays).attr({x:function(i){return a.scale.x(i.x)},y:function(){return-11},height:30,"text-anchor":"middle"})},DynamicPricingWidget.prototype._plotXMarker=function(){var a=this,i=this.svg.selectAll(".lp_dynamic-pricing__x-axis-marker").data(this.data.slice(1,this.data.length));i.enter().append("line").attr("class",function(i,t){var n="lp_dynamic-pricing__x-axis-marker";return t===a.data.length-2&&(n+=" lp_is-hidden"),n}).call(this.dragBehavior.x),i.exit().remove(),i.transition().duration(this.dragging?0:250).attr({x1:function(i){return a.scale.x(i.x)},y1:function(){return 0},x2:function(i){return a.scale.x(i.x)},y2:function(i){return a.scale.y(i.y)-4.5}})},DynamicPricingWidget.prototype._plotPriceCurvePoints=function(){var a=this,i=this.svg.selectAll(".lp_dynamic-pricing__price-curve-point").data(this.data);i.enter().append("circle").attr("class",function(i,t){var n="lp_dynamic-pricing__price-curve-point";return 0!==t&&t!==a.data.length-1||(n+=" lp_is-hidden"),n}).attr("r",0),i.transition().duration(this.dragging?0:250).attr({r:4.5,cx:function(i){return a.scale.x(i.x)},cy:function(i){return a.scale.y(i.y)}}),i.exit().remove()},DynamicPricingWidget.prototype._plotPriceMarker=function(){var i=this,t=this.svg.selectAll(".lp_dynamic-pricing__current-price-marker").data(this.data.slice(1,this.data.length));0<this.pubDays&&(t.enter().append("line").attr("class","lp_dynamic-pricing__current-price-marker"),t.exit().remove(),t.transition().duration(this.dragging?0:250).attr({x1:function(){return i.scale.x(dynamicPricingWidget.pubDays)},y1:function(){return i.scale.y(0)},x2:function(){return i.scale.x(dynamicPricingWidget.pubDays)},y2:function(){return i.scale.y(dynamicPricingWidget.maxPrice)}}))},DynamicPricingWidget.prototype.plot=function(){this._setDimensions(),this._setScale(),d3.select(".lp_dynamic-pricing__svg").attr({width:this.dimensions.width+margin.xAxis,height:this.dimensions.height+margin.yAxis}).select(".lp_dynamic-pricing__svg-group").attr("transform","translate("+(margin.left-11)+","+margin.top+")"),this.svg.select(".lp_dynamic-pricing__graph-background").transition().duration(this.dragging?0:250).attr({width:this.dimensions.width+10,height:this.dimensions.height}),this._plotAxes(),this._plotPriceCurve(),this._plotPriceCurvePoints(),this._setDragBehavior(),this._plotStartPriceHandle(),this._plotEndPriceHandle(),this._plotDaysHandle(),this._plotXMarker(),this._plotPriceMarker()},DynamicPricingWidget.prototype.toggleStartInput=function(i){var t=dynamicPricingWidget.get_data(),n=t[0].y.toFixed(2),a=jQuery(".lp_dynamic-pricing__start-price-handle, .lp_dynamic-pricing__start-price-handle-triangle, .lp_dynamic-pricing__start-price-value, .lp_dynamic-pricing__start-price-currency"),e=jQuery(".lp_dynamic-pricing__start-price-input"),r=-1<(r=e.val()).indexOf(",")?parseFloat(r.replace(",",".")):parseFloat(r);-1!==lpVars.locale.indexOf("de_DE")&&(n=n.replace(".",",")),"show"===i?(a.hide(),e.val(n).show().focus()):"save"===i?(r>this.maxPrice?r=this.maxPrice:r<this.minPrice&&0!==r&&(r=this.minPrice),t[0].y=r,t[1].y=r,e.hide(),a.show(),dynamicPricingWidget.set_data(t),dynamicPricingWidget.plot()):"cancel"===i&&(e.hide(),a.show())},DynamicPricingWidget.prototype.toggleEndInput=function(i){var t=dynamicPricingWidget.get_data(),n=t[2].y.toFixed(2),a=jQuery(".lp_dynamic-pricing__end-price-handle, .lp_dynamic-pricing__end-price-handle-triangle, .lp_dynamic-pricing__end-price-value, .lp_dynamic-pricing__end-price-currency"),e=jQuery(".lp_dynamic-pricing__end-price-input"),r=-1<(r=e.val()).indexOf(",")?parseFloat(r.replace(",",".")):parseFloat(r);-1!==lpVars.locale.indexOf("de_DE")&&(n=n.replace(".",",")),"show"===i?(a.hide(),e.val(n).show().focus()):"save"===i?(r>this.maxPrice?r=this.maxPrice:r<this.minPrice&&0!==r&&(r=this.minPrice),t[2].y=r,t[3].y=r,e.hide(),a.show(),dynamicPricingWidget.set_data(t),dynamicPricingWidget.plot()):"cancel"===i&&(e.hide(),a.show())};